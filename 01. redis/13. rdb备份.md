>## 十三、rdb备份
#

### 1. 什么是rdb？
```bash
  原理介绍:
    #rdb (Redis DataBase)
    #rdb 消耗内存,AOF 消耗性能.
    #在制定的时间间隔内将内存中的数据集快照写入磁盘
    #它恢复时是将快照文件直接读到内存里.
    #redis会单独创建(fork)一个子进程来进行持久化,会先将数据写入到一个临时文件中,待持久化过程都结束了,再用这个临时文件替换上次持久化好的文件.
    #整个过程中,主进程是不进行任何IO操作的,这就确保了极高的性能.
    #如果需要进行大规模的数据的恢复,且对于数据恢复的完整性不是非常敏感,那么RDB方式要比AOF方式更加的高效
    #RDB的缺点就是最后一次持久化后的数据可能丢失.
    #默认我们使用就是RDB,默认保存文件叫dump.rdb,默认参数配置save足够使用.

  触发生成RDB规则:
    #根据配置文件规则,进行生成.redis.cnf save ""
    #save命令,手动执行会生成rdb文件.
    #flushdb
    #flushall执行后会生成rdb文件.
    #redis正常关机的时候也会产生rdb文件

  优点:
    #适合大规模的数据恢复,只要dump.rdb在命根子就在.
    #只要对数据完整性要求不高就适合,应该save命令是有执行规则的,不是时时的.
  缺点:  
    #需要一定的时间的间隔进行操作.save命令执行的间隔.
    #如果redis意外宕机,这个最后一次修改数据就没有了.
    #fork进程的时候,会占用一定的内存空间.

   配置参数:
    #vim redis.conf
    #save ""

    
  持久化快照过程原理图:

     _________    3.处理新的请求   _______    2.继续处理client请求
    |内存页副本 | <-------------- | 父进程 | <-------------------
     ---------                   -------   
                              /     |
                            /       |
                          /         | 1.fork
           os写时复制进制  V          |
                _________           V
                | 共享内存 |      ------- 
                ---------       | 子进程 |
                                 ———————  
                                    |
                                    | 2.将内存内容写入.
                                    |
                                    V
                                 -------    4.快照写入完成后     -----------
                                | 临时RDB| -----------------> | 正式RDB文件 |
                                 ———————    替换原来快照文件     ————————————
                                             子进程退出    
```

### 2. rdb备份
```bash

    127.0.0.1:6379> flushdb                                #清空当前库,会触发rdb生成.
    127.0.0.1:6379> flushall                               #清空所有库,会触发rdb生成.
    127.0.0.1:6379> save                                   #进行手动保存,会触发生成rdb文件.
    
```


### 3. rdb恢复
```bash
    #只需要将rdb文件放在我们redis启动目录就可以.
    #redis启动的时候会自动检查dump.rdb恢复其中的数据.

    127.0.0.1:6379> config get dir                         #恢复的时候放在这个位置,启动就会自动恢复其中的数据.
    
```

### 4. 修复rdb文件
```bash
    cd bin/
    redis-check-rdb --fix dump.rdb
  
```