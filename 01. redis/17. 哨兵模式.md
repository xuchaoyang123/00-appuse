>## 十七、哨兵模式
#

### 1.基本信息
```bash
 概念:
    #哨兵(sentinel)
    #自动选取老大的模式.
    #redis从2.8开始正式提供了哨兵架构来解决这个问题.
    #搂草篡位自动版,能够后台监控主机是否故障,如果故障了根据投票数自动将从库转为主库.
    #哨兵模式是一种特殊的模式,首先redis提供了哨兵的命令,哨兵是一个独立的进程.
    #作为进程它会独立运行,其原理是哨兵通过发送命令,等待redis服务器响应,从而监控运行的多个redis实例.
  作用:
    #通过发送指令,让redis服务器返回监控其运行状态,包括主服务器和从服务器.
    #当哨兵监测到master宕机,会自动将slave切换成master,然后通过发布订阅模式通知其他的从服务器,修改配置文件,让他们切换主机.
    #然而一个哨兵进程对redis服务器进行监控,可能会出现问题,为此我们可以使用多个哨兵进行监控,各个哨兵之间还会进行监控,这样形成了多哨兵模式.
    
    #假设主服务器宕机,哨兵1线检测到这个结果,系统并不会马上进行fallover过程,仅仅是哨兵1主观的认为主服务器不可用,这个现成成为<主观下线>
    #当后面的哨兵也检测到主服务器不可用,并且数量到达一定值时,那么哨兵之间就会进行一次投票,投票的结果由一个哨兵发起,进行failover<故障转移>操作.
    #切换成功后,就会通过发布订阅模式,让各个哨兵把自己监控的从服务器实现切换主机,这个过程为<客观下线>
    #如果主机重新启动,会自动变为从机加入集群.

   优点:
     1.哨兵模式是基于主从模式的,主从的优点他全有.
     2.主从可以切换,故障可以转移,系统的可用性就会更好.
     3.哨兵模式就是主从模式的升级,手动到自动,更加健壮.
   缺点:
      1.redis不好在线扩容,集群容量一旦到达上限,在线扩容就十分麻烦.
      2.实现哨兵模式的配置其实是很麻烦,里面有很多选择.

 原理:                  

                         单哨兵
                         ————
        +---------------| 主 |---------------+
        |                ————                |
        |                  ^                 |
        |                  |                 |
        V                  |                 V
       ————              ————              ———— 
      | 从 | <--------- | 哨兵| ---------->| 从 |       
       ————              ————              ———— 



                        多哨兵
       ————              ————               ———— 
      |哨兵 | <--------->| 哨兵| <--------->|哨兵 |       
       ————    \         ————            /  ———— 
        |       \         |            /      |
        |         \       |         /         |
        V           \     V      /            V
       ————            > ———— <             ———— 
      | 从 | <--------- | 主 | ----------> | 从 |       
       ————              ————              ———— 

```


### 2.哨兵的全部配置
```bash
  port 26379                                                    #哨兵模式的端口.
  dir "/tmp"                                                    #定义哨兵的工作目录
  sentinel monitor mymaster 192.168.1.100 6379 1                #哨兵监控主节点.
  sentinel auth-pass mymaster 123                               #主节点如果有密码进行配置.
  sentinel down-after-milliseconds mymaster 1500                #制定多少毫秒之后,主节点没有应答哨兵,此时哨兵主观上认为主节点下线,默认30秒,默认单位<milliseconds>
  sentinel parallel-syncs <master-name> <numslaves>             #制定在发生切换主备时最多可以有多少个slave同时对新master进行同步.
  sentinel failover-timeout mymaster 80000                      #故障转移的超时时间.默认三分钟.
  sentinel notification-script <master-name> <script-path>      #配置当某一事件发生时所需要执行的脚本,可以实现出现问题发送邮件通知管理员.
  sentinel client-reconfig-script <master-name> <script-path>   #当一个master切换改变时,这个脚本会被调用,邮件通知谁是主节点.


```

### 3.一个哨兵的配置
```bash
    #1.初始环境为:一主两从
    

    #2.固定的配置文件名
     vim sentinel.conf
        #sentinel monitor 被监控的名称 host port <数字> #数字用于投票. 
        sentinel monitor myredis1 192.168.1.100 6379 1    
    #3.启动哨兵模式
    redis-sentinel sentinel.conf

```