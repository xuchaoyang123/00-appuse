>## 十八、redis高可用集群
#

### 1.基本信息
```bash
  概念:
     #多个master,至少要3个master,每个master上面的数据都不一样,进行了分片.
     #如果客户端链接到了没有数据到节点到,会自动路由重定向到有数据的节点上.
     #最多可扩展master 1000个.
     #正常情况下,如果其中一个分片进行故障切换,会话会优先打到其他分片上.
     #如果会话链接其中一个分片的时候还没有故障切换,访问的时候正好故障切换,这个会话还是会失败的.
     #插入数据是顺序到每个分片上,进行分摊.
     #jedisCluster是java的一个sdk.




  架构:
                  ——————              —————— 
                 |client|            |client|
                  ——————              —————— 
                    |                   |
                    |                   |
                    v                   v
            —————————————————————————————————————————
           |             jedisCluster                |   
            —————————————————————————————————————————
              |                |               |
              |                |               |
              v                v               v
        192.168.1.10       192.168.1.13     192.168.1.16
            ——————           ——————          —————— 
           |master|         |master|        |master|       
            ——————           ——————          ——————     
             / \              / \             / \
            /   \            /   \           /   \
        —————   —————     —————   —————    —————   —————
       |slave| |slave|   |slave| |slave|  |slave| |slave|
        —————   —————     —————   —————    —————   —————
        1.11    1.12      1.14     1.15    1.17     1.18

```


### 2.实战部署
```bash

    #1.[master01操作]:修改配置文件
      vim redis.conf
          daemonize yes
          port <port>
          bind <hostip>
          dir <dir>
          cluster-enabled yes                                   #启动集群模式
          cluster-config-file nodes-6379.conf                   #设置集群单独的配置文件.
          cluster-node-timeout 15000                            #集群超时时间
          appendonly yes

    #2.[ALL节点操作]: 将配置文件scp到所有节点上,并且根据环境修改配置文件ip端口信息.

    #3.[ALL节点操作]: 程序启动使用ruby命令,需要安装ruby.
       yum install ruby  rubygems 
       gem install redis --version 3.0.0 (修改实际的版本,安装redis和ruby的接口)


    #4.[ALL节点操作]: 分别启动所有redis实例,然后检查是否启动成功.
        /usr/local/redis/bin/redis-server /usr/local/redis/conf/redis.conf
        ps -ef | grep redis 

    #5.[master01操作]:创建redis集群.
       #数字1 代表master/slave的比例.
       #master 3个,slave 3个,即3/3=1 
       #master 3个,slave 6个,即3/6=0.5 
       #脚本规定:前面的是主,后面的是从.
       #脚本规定:主节点第一台对应从节点第一台.
    
       #./redis-trilb.rb create --replicas 0.5 <masterip>:<port>  <masterip>:<port> <masterip>:<port>  <slaveip>:<port>  ...
       ./redis-trilb.rb create --replicas 0.5 192.168.1.10:6379  192.168.1.13:6379 192.168.1.16:6379  192.168.1.11:6379 192.168.1.12:6379...

    #6.[master01操作]:进行登录验证
        #-c cluster简写
        
       ./redis-cli -c  -h 192.168.1.10 -p 6379 
       > cluster info
       > cluster nodes                                          #myself 代表当前登录在这个节点

    #7.[ALL节点操作]: 集群关闭,需要逐个关闭.
       ./redis-cli -c  -h 192.168.1.10 -p 6379 shutdown
       

```