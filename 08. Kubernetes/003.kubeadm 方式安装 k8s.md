<!--
 * @Author: your name
 * @Date: 2021-05-09 21:29:49
 * @LastEditTime: 2021-05-28 18:00:51
 * @LastEditors: Please set LastEditors
 * @Description: In User Settings Edit
 * @FilePath: /01-good/use/08. Kubernetes/003.kubeadm方式部署k8s.md
-->

> ## kubeadm 方式安装 k8s

#

### 1.平台规划

```bash

  节点规划:
        #master 192.168.44.141
        #node1  192.168.44.142
        #mode2  192.168.44.143

 测试环境最小要求
            master
                    #2核 4G 20G
            node
                    #4核 8G 40G


```

### 2.服务器初始化

```bash


#1.[所有节点] 关闭防火墙
	systemctl stop firewalld
	systemctl disable firewalld


#2.[所有节点] 关闭seliunx
	sed -i 's/enforcing/disabled/' /etc/seliunx/config #永久
	setenforce 0 #临时


#3.[所有节点] 关闭swap
	swapoff -a  #临时
	sed -ri 's/.*swap.*/#&/' /etc/fstab #永久


#4.[所有节点] 根据规划设置主机名
	hostnamectl set-hostname master
	hostnamectl set-hostname node1
	hostnamectl set-hostname node2


#5.[master节点] 在master添加hosts
	cat >> /etc/hosts <<EOF
	192.168.44.141 master
	192.168.44.142 node1
	192.168.44.143 node2
	EOF


#6.[所有节点] 将桥接的ipv4流量传递到iptables的链
	cat > /etc/sysctl.d/k8s.conf <<EOF
	net.bridge.bridge-nf-call-ip6tables=1
	net.bridge.bridge-nf-call-iptables=1
	EOF
	sysctl --system  #生效



#7.[所有节点] 时间同步
	yum install ntpdate -y
	ntpdate time.windos.com


#8.[所有节点]配置阿里云yum源

        cat <<EOF > kubernetes.repo
        [kubernetes]
        name=Kubernetes
        baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64
        enabled=1
        gpgcheck=1
        repo_gpgcheck=1
        gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg
        EOF

```

### 3.安装 docker

```bash
   #kubernetes默认CRI(容器运行时)为docker,因此先安装docker.

#1.[所有节点] yum配置
        yum-config-manager \
        --add-repo \
        https://download.docker.com/linux/centos/docker-ce.repo

#2.[所有节点] 安装
        yum install docker-ce docker-ce-cli containerd.io -y               安装docker ce 社区版


#3.[所有节点] 配置国内镜像加速
        sudo mkdir -p /etc/docker                                           #更换国内镜像站
        sudo tee /etc/docker/daemon.json <<-'EOF'
        {
        "registry-mirrors": ["https://slfru11m.mirror.aliyuncs.com"]
        }
        EOF

#4.[所有节点] 启动服务
        sudo systemctl daemon-reload
        sudo systemctl restart docker

#5.[所有节点] 测试
        docker  info                                                        #详细的信息 包括镜像和容器个数


```

### 4.安装 kubeadm,kubelet 和 kubectl

```bash
#1.[所有节点]安装
        #yum install -y kubelet-1.18.0 kubeadm-1.18.0 kubectl-1.18.0
        #systemctl enable kubelet

```

### 5.部署 kubernetes master

```bash
#1. [master节点]操作
        $kubeadm init \
        --apiserver-advertise-address=192.168.44.146 \
        --image-repository registry.aliyuncs.com/google_containers \
        --kubernetes-version v1.18.0 \
        --service-cidr=10.96.0.0./12 \
        --pod-network-cidr=10.244.0.0/16

        #[执行完后的提示信息]
        #由于默认拉取镜像地址K8s.gcr.io国内无法访问,这里制定阿里云镜像仓库地址.
        #使用kubectl工具:
        mkdir -p $HOME/.kube
        sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
        sudo chown $(id -u):$(id -g) $HOME/.kube/config
        $kubectl get nodes


```

### 6.加入 kubernetes Node

```bash

#1.[2个node节点] kubeadm init输出的kubeadm join命令
        #向集群添加新节点
        $kubeadm join 192.168.4.146:6443 --token esce21.q6hetwm8si29qxwn \
                --discovery-token-ca-cert-hash
                sha256:00603a05805807501d7181c3d60b478788408cfe6cedefedb1f97569708be9c5

        #默认token有效期为24小时,当过期之后,该token就不可用了,这时就需要重新创建token,操作如下
        kubeadm token create --print-join-command

#2.[master节点] 查看集群状态
        $kubectl get nodes

```

### 7.部署 CNI 网络插件

```bash
#1.[master节点] 默认镜像地址无法访问,sed命令修改为docker hub镜像仓库.
        $kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml
        $kubectl get pods -n kube-system

#2.如果域名无法下载
        找到域名对应的ip地址
	        http://ip.tool.chinaz.com/  #raw.githubusercontent.com
        添加主机ip映射信息
                vim /etc/hosts
        重新获取：
                kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml


```

### 8.测试 kubernetes 集群

```bash
#1.[master节点] 在kubernetes集群中创建一个pod,验证是否正常运行
        $kubectl create deployment nginx --image=nginx
        $kubectl expose deployment nginx --port=80 --type=NodePort
        $kubectl  get pod,svc
```
